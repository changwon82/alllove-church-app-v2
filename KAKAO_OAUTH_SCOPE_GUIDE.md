# 카카오 OAuth Scope 및 동의 항목 설정 가이드

## 📋 목차
1. [Scope란 무엇인가?](#scope란-무엇인가)
2. [필요한 Scope 설명](#필요한-scope-설명)
3. [Supabase에서 Scope 설정](#supabase에서-scope-설정)
4. [카카오 개발자 콘솔에서 동의 항목 설정](#카카오-개발자-콘솔에서-동의-항목-설정)
5. [단계별 설정 가이드](#단계별-설정-가이드)

---

## Scope란 무엇인가?

**Scope(스코프)**는 OAuth 인증 시 애플리케이션이 사용자로부터 받을 수 있는 권한의 범위를 의미합니다.

- 사용자가 로그인할 때 "이 애플리케이션이 내 이메일 주소를 가져갈 수 있나요?" 같은 동의를 받는 것
- 각 scope는 특정 정보나 기능에 대한 접근 권한을 나타냅니다
- 사용자가 동의하지 않으면 해당 정보를 받을 수 없습니다

---

## 필요한 Scope 설명

### 1. `profile_nickname` (닉네임)

**설명:**
- 카카오 사용자의 닉네임을 가져올 수 있는 권한
- `kakao_account.profile.nickname` 값으로 제공됩니다

**사용 목적:**
- 사용자의 프로필 이름(`full_name`)으로 자동 설정
- 사용자가 별도로 이름을 입력하지 않아도 됨

**중요도:** ⭐⭐⭐ (높음)

---

### 2. `profile_image` (프로필 이미지)

**설명:**
- 카카오 사용자의 프로필 사진을 가져올 수 있는 권한
- `kakao_account.profile.profile_image_url` (큰 이미지)
- `kakao_account.profile.thumbnail_image_url` (작은 이미지)
- 두 값 모두 제공됩니다

**사용 목적:**
- 사용자의 프로필 사진을 자동으로 설정
- 현재 코드에서는 사용하지 않지만, 향후 사용 가능

**중요도:** ⭐⭐ (보통)

---

### 3. `account_email` (이메일)

**설명:**
- 카카오 계정에 연결된 이메일 주소를 가져올 수 있는 권한
- `kakao_account.email` 값으로 제공됩니다

**사용 목적:**
- 사용자 계정 식별
- 이메일 기반 기능 (비밀번호 재설정 등)
- 프로필 정보 저장

**중요도:** ⭐⭐⭐ (높음)

**⚠️ 특별 주의사항:**
- **사업자 인증이 필요합니다**
- 개인 개발자 계정으로는 이 scope를 사용할 수 없습니다
- 카카오 개발자 콘솔에서 "사업자 인증"을 완료해야 합니다
- 사업자 인증이 없으면 `KOE205` 에러가 발생할 수 있습니다

---

## Supabase에서 Scope 설정

### 방법 1: 코드에서 명시적으로 지정 (권장)

현재 코드를 다음과 같이 수정하면 됩니다:

```typescript
const { data, error } = await supabase.auth.signInWithOAuth({
  provider: "kakao",
  options: {
    redirectTo: `${window.location.origin}/auth/callback`,
    scopes: "profile_nickname profile_image account_email", // scope 명시
    queryParams: {
      theme: "light",
    },
  },
});
```

**장점:**
- 어떤 정보를 요청하는지 명확함
- 코드로 관리 가능
- 버전 관리 가능

---

### 방법 2: Supabase 대시보드에서 설정

1. [Supabase Dashboard](https://app.supabase.com) 접속
2. 프로젝트 선택
3. **Authentication → Providers → Kakao** 클릭
4. **Scopes** 필드에 입력:
   ```
   profile_nickname profile_image account_email
   ```
5. **Save** 클릭

**장점:**
- 코드 수정 불필요
- 중앙 집중식 관리

**단점:**
- 코드에서 확인하기 어려움
- 버전 관리 불가

---

## 카카오 개발자 콘솔에서 동의 항목 설정

⚠️ **중요:** Supabase에서 scope를 설정해도, 카카오 개발자 콘솔에서 동의 항목을 활성화하지 않으면 작동하지 않습니다!

### 단계별 설정 방법

#### 1단계: 카카오 개발자 콘솔 접속

1. [카카오 개발자 콘솔](https://developers.kakao.com/) 접속
2. 로그인
3. **내 애플리케이션** 클릭
4. 사용할 앱 선택

---

#### 2단계: 동의 항목 메뉴로 이동

1. 왼쪽 메뉴에서 **제품 설정** 클릭
2. **카카오 로그인** 클릭
3. **동의항목** 탭 클릭

---

#### 3단계: 이메일 동의 항목 설정

1. **이메일** 항목 찾기
2. **설정** 버튼 클릭
3. 다음 설정:
   - ✅ **필수 동의**: 체크
     - 사용자가 반드시 동의해야 함
     - 동의하지 않으면 로그인 불가
   - ✅ **동의 화면 노출**: 체크
     - 로그인 시 동의 화면에 표시
   - **동의 목적**: "서비스 이용을 위한 본인 확인" (예시)
4. **저장** 클릭

**⚠️ 주의:**
- 사업자 인증이 완료되지 않으면 이메일 동의 항목을 활성화할 수 없습니다
- 사업자 인증 방법:
  1. 카카오 개발자 콘솔 → 내 애플리케이션 → 앱 설정
  2. **앱 설정** → **사업자 인증** 메뉴
  3. 사업자 등록증 업로드 및 정보 입력
  4. 승인 대기 (보통 1-3일 소요)

---

#### 4단계: 프로필 정보 동의 항목 설정

1. **프로필 정보(닉네임/프로필 사진)** 항목 찾기
   - 카카오는 닉네임과 프로필 사진을 하나의 항목으로 묶어서 제공합니다
2. **설정** 버튼 클릭
3. 다음 설정:
   - ⚠️ **필수 동의**: 체크 해제 (선택 동의로 설정)
     - 사용자가 선택적으로 동의할 수 있음
     - 동의하지 않아도 로그인 가능
   - ✅ **동의 화면 노출**: 체크
     - 로그인 시 동의 화면에 표시
   - **동의 목적**: "서비스 이용을 위한 프로필 정보 제공" (예시)
4. **저장** 클릭

**참고:**
- 프로필 정보는 카카오 로그인의 기본 제공 항목입니다
- 필수 동의로 설정해도 되지만, 사용자 경험을 위해 선택 동의를 권장합니다

---

#### 5단계: 설정 확인

1. 모든 동의 항목이 올바르게 설정되었는지 확인
2. **저장** 버튼 클릭 (페이지 상단 또는 하단)
3. ⏰ **5-10분 대기** (카카오 서버에 설정이 반영되는 시간)

---

## 단계별 설정 가이드

### 전체 설정 순서 요약

```
1. 카카오 개발자 콘솔 접속
   ↓
2. 사업자 인증 완료 (이메일 사용 시 필수)
   ↓
3. 동의 항목 설정
   - 이메일: 필수 동의 ✅
   - 프로필 정보: 선택 동의 ⚠️
   ↓
4. Supabase 대시보드에서 Kakao Provider 활성화
   - Client ID 입력
   - Scope 설정 (선택사항)
   ↓
5. 코드에서 scope 명시 (권장)
   ↓
6. 테스트
```

---

## 설정 확인 체크리스트

설정이 완료되었는지 확인하세요:

### 카카오 개발자 콘솔
- [ ] 사업자 인증 완료 (이메일 사용 시)
- [ ] 이메일 동의 항목 활성화
  - [ ] 필수 동의 체크
  - [ ] 동의 화면 노출 체크
- [ ] 프로필 정보 동의 항목 활성화
  - [ ] 동의 화면 노출 체크
- [ ] Redirect URI 설정 완료
  - [ ] `https://your-domain.com/auth/callback`
  - [ ] `http://localhost:3000/auth/callback` (개발용)

### Supabase 대시보드
- [ ] Kakao Provider 활성화
- [ ] Client ID (REST API Key) 입력
- [ ] Redirect URL 확인
- [ ] Scope 설정 (선택사항)

### 코드
- [ ] `signInWithOAuth`에서 scope 명시 (권장)
- [ ] Redirect URL 설정 확인

---

## 자주 발생하는 문제

### 문제 1: KOE205 에러

**에러 메시지:**
```
잘못된 요청 (KOE205)
설정하지 않은 카카오 로그인 동의 항목을 포함해 인가 코드를 요청했습니다.
설정하지 않은 동의 항목: account_email, profile_image, profile_nickname
```

**원인:**
- 카카오 개발자 콘솔에서 해당 동의 항목이 활성화되지 않음

**해결 방법:**
1. 카카오 개발자 콘솔 → 동의항목 메뉴로 이동
2. 에러 메시지에 나온 동의 항목들을 모두 활성화
3. 5-10분 대기 후 다시 시도

---

### 문제 2: 이메일을 받을 수 없음

**원인:**
- 사업자 인증이 완료되지 않음
- 이메일 동의 항목이 활성화되지 않음

**해결 방법:**
1. 카카오 개발자 콘솔에서 사업자 인증 완료
2. 이메일 동의 항목 활성화
3. 필수 동의로 설정

---

### 문제 3: 닉네임이 null로 저장됨

**원인:**
- 프로필 정보 동의 항목이 활성화되지 않음
- 사용자가 프로필 정보 동의를 거부함

**해결 방법:**
1. 카카오 개발자 콘솔에서 프로필 정보 동의 항목 활성화
2. 코드에서 사용자가 동의하지 않은 경우를 처리

---

## 참고 자료

- [카카오 로그인 REST API 가이드](https://developers.kakao.com/docs/latest/ko/kakaologin/rest-api)
- [카카오 동의 항목 가이드](https://developers.kakao.com/docs/latest/ko/kakaologin/consent)
- [Supabase 카카오 로그인 가이드](https://supabase.com/docs/guides/auth/social-login/auth-kakao)

---

## 현재 프로젝트 설정 상태

현재 코드에서는 scope를 명시적으로 지정하지 않고 있습니다.
Supabase가 카카오 개발자 콘솔에서 설정된 동의 항목을 자동으로 요청합니다.

**권장 사항:**
- 코드에서 scope를 명시적으로 지정하는 것을 권장합니다
- 이렇게 하면 어떤 정보를 요청하는지 명확해집니다
